<div class="h-screen w-full flex relative overflow-hidden">
  @if (sidebarAberta) {
    <div class="fixed inset-0 bg-black/50 z-30 lg:hidden" (click)="closeSidebar()"></div>
  }

  <aside
    class="fixed lg:static left-0 top-0 z-40 w-80 lg:w-64 h-full bg-white border-r border-gray-200 transform transition-transform duration-300 lg:translate-x-0 flex flex-col"
    [ngClass]="{
      'translate-x-0': sidebarAberta,
      '-translate-x-full': !sidebarAberta,
    }"
  >
    <div class="p-6 pb-4">
      <button
        (click)="toggleSidebar($event)"
        class="text-2xl font-bold text-[#19AA79] hover:text-[#148b63] transition-colors duration-200"
      >
        Medical AI
      </button>
    </div>

    <div class="px-6 space-y-2">
      <button
        (click)="novoChat()"
        class="w-full bg-[#19AA79] text-white rounded-lg py-2.5 px-4 font-medium hover:bg-[#148b63] transition-all duration-200 shadow-sm hover:shadow flex items-center justify-center gap-2 group"
      >
        <svg
          class="w-5 h-5 transition-transform group-hover:rotate-90"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          />
        </svg>
        Novo chat
      </button>

      <button
        class="w-full bg-gray-50 text-gray-700 rounded-lg py-2.5 px-4 font-medium hover:bg-gray-100 transition-all duration-200 border border-gray-200 hover:border-gray-300"
      >
        Gerar resumo
      </button>

      <button
        class="w-full bg-gray-50 text-gray-700 rounded-lg py-2.5 px-4 font-medium hover:bg-gray-100 transition-all duration-200 border border-gray-200 hover:border-gray-300"
      >
        Galeria de arquivos
      </button>
    </div>

    <div class="mx-6 my-5 border-t border-gray-200"></div>

    <div class="flex-1 overflow-hidden flex flex-col px-6 pb-6">
      <h3 class="text-gray-500 text-xs font-semibold uppercase tracking-wide mb-3">
        Histórico de Chats
      </h3>

      <div class="flex-1 overflow-y-auto sidebar-scroll -mx-2 px-2">
        <div class="space-y-1">
          @for (chat of chatService.chats(); track chat.id) {
            <button
              (click)="selecionarChat(chat)"
              class="w-full text-left rounded-lg px-3 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-all duration-200 group relative overflow-hidden"
              [class.bg-gray-100]="chatService.chatAtual()?.id === chat.id"
              [class.text-[#19AA79]]="chatService.chatAtual()?.id === chat.id"
            >
              <div class="flex items-center justify-between gap-2">
                <span class="truncate flex-1">{{ chat.nome }}</span>

                <button
                  (click)="editarNomeChat($event, chat)"
                  class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1 hover:bg-gray-200 rounded shrink-0"
                  title="Editar nome"
                >
                  <svg
                    class="w-4 h-4 text-gray-500 hover:text-[#19AA79]"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                    />
                  </svg>
                </button>
              </div>

              <div
                class="absolute left-0 top-0 bottom-0 w-1 bg-[#19AA79] transform transition-transform duration-200"
                [class.-translate-x-full]="chatService.chatAtual()?.id !== chat.id"
                [class.translate-x-0]="chatService.chatAtual()?.id === chat.id"
              ></div>
            </button>
          }
        </div>
      </div>
    </div>
  </aside>

  <div class="flex-1 flex flex-col min-h-screen bg-slate-50">
    <header
      class="w-full bg-linear-to-r from-[#19AA79] to-[#148b63] text-white h-[78px] flex items-center justify-between px-6 shadow-sm sticky top-0 z-45"
    >
      <button
        class="lg:hidden p-2 rounded-xl bg-white/10 hover:bg-white/20 active:scale-95 transition-all flex items-center justify-center"
        (click)="toggleSidebar($event)"
      >
        <img src="assets/menu.png" class="w-6 h-6 brightness-0 invert" alt="Menu" />
      </button>

      <div class="hidden lg:block"></div>

      <div class="relative ml-auto">
        <button (click)="toggleUserMenu()" class="group flex items-center gap-3 focus:outline-none">
          <div
            class="w-10 h-10 rounded-full border-2 border-white/30 group-hover:border-white transition-all p-0.5 shadow-sm"
          >
            <img
              [src]="userInfo.avatar || 'assets/user.png'"
              class="w-full h-full rounded-full object-cover"
              [alt]="userInfo.name || 'User'"
            />
          </div>
        </button>
      </div>
    </header>

    <div class="h-full bg-white flex items-center justify-center">
      <div
        class="bg-white flex flex-col w-full h-full rounded-none lg:w-[50%] lg:h-[90%] lg:rounded-xl"
      >
        <div class="flex-1 overflow-y-auto p-4 space-y-3">
          <div class="flex justify-start">
            <div #scrollContainer class="flex-1 overflow-y-auto p-4 pb-20">
              <div class="flex flex-col justify-end grow space-y-2">
                @if (messages) {
                  @for (msg of messages; track msg.id) {
                    <div class="mb-4" [ngClass]="{ 'text-right': msg.foi_usuario }">
                      <div
                        [ngClass]="{
                          'bg-[#19AA79] user-bubble': msg.foi_usuario,
                          'bg-[#198879] bot-bubble': !msg.foi_usuario,
                        }"
                        class="inline-block text-white px-3 py-2 rounded-lg wrap-break-words"
                      >
                        @if (msg.foi_usuario) {
                          <div class="text-left">{{ msg.text }}</div>
                        } @else {
                          <markdown [data]="msg.text"></markdown>
                        }
                      </div>
                    </div>
                  }
                }

                @if (firstMessage) {
                  <app-sugestoes-component
                    [titulo]="tituloSugestao"
                    [opcoes]="opcoesSugestao"
                    (eventoClick)="enviarSugestao($event)"
                  >
                  </app-sugestoes-component>
                }
              </div>
            </div>
          </div>
        </div>
        <div
          class="sticky bottom-0 w-full z-30 pb-4 bg-linear-to-t from-white via-white to-transparent pt-8"
        >
          <div class="mx-auto w-full max-w-3xl px-4">
            <div
              class="relative bg-white border border-gray-300 rounded-3xl shadow-sm hover:shadow-md transition-shadow"
            >
              <div class="px-4 pt-3 pb-2">
                <textarea
                  #textarea
                  [(ngModel)]="newMessage"
                  (input)="autoResize($event)"
                  rows="1"
                  (keyup.enter)="enviarMensagem()"
                  placeholder="Pergunte alguma coisa"
                  class="chat-input w-full resize-none text-[15px] text-gray-800 placeholder-gray-400 outline-none leading-relaxed bg-transparent overflow-hidden break-all"
                  style="max-height: 200px"
                ></textarea>
              </div>

              <div class="flex items-center justify-between gap-2 px-3 pb-3 pt-1">
                <div>
                  <button
                    (click)="importarArquivo()"
                    class="group px-4 py-2 rounded-lg bg-white text-gray-700 border border-gray-200 hover:border-[#19AA79] hover:bg-[#19AA79]/5 transition-all duration-200 ease-in-out shadow-sm hover:shadow-md font-medium text-sm flex items-center gap-2"
                  >
                    Adicionar arquivo
                  </button>
                </div>

                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    (click)="toggleGravacao()"
                    class="relative w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300 ease-out shadow-md hover:shadow-lg group overflow-hidden"
                    [class.bg-[#19AA79]]="!gravando"
                    [class.hover:bg-[#15885f]]="!gravando"
                    [class.bg-red-500]="gravando"
                    [class.animate-pulse]="gravando"
                  >
                    <span
                      *ngIf="gravando"
                      class="absolute inset-0 rounded-full bg-red-400 animate-ping opacity-75"
                    >
                    </span>

                    <img
                      src="assets/mic.png"
                      alt="Microfone"
                      class="w-5 h-5 relative z-10 transition-all duration-300"
                      [class.scale-110]="gravando"
                      [class.brightness-0]="!gravando"
                      [class.invert]="!gravando"
                    />
                  </button>

                  <button
                    type="button"
                    (click)="enviarMensagem()"
                    [disabled]="!newMessage.trim()"
                    class="relative w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300 ease-out shadow-md group overflow-hidden"
                    [class.bg-[#19AA79]]="newMessage.trim()"
                    [class.hover:bg-[#15885f]]="newMessage.trim()"
                    [class.hover:shadow-lg]="newMessage.trim()"
                    [class.hover:scale-105]="newMessage.trim()"
                    [class.bg-gray-200]="!newMessage.trim()"
                    [class.cursor-not-allowed]="!newMessage.trim()"
                  >
                    <span
                      *ngIf="newMessage.trim()"
                      class="absolute inset-0 bg-linear-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"
                    >
                    </span>

                    <img
                      src="assets/enviar.png"
                      alt="Enviar"
                      class="w-4 h-4 relative z-10 transition-all duration-300"
                      [class.brightness-0]="newMessage.trim()"
                      [class.invert]="newMessage.trim()"
                      [class.opacity-40]="!newMessage.trim()"
                      [class.group-hover:translate-x-0.5]="newMessage.trim()"
                    />
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  @if (menuStateService.isUserMenuOpen()) {
    <div
      class="fixed inset-0 z-9998"
      (click)="closeUserMenu()"
      style="background: transparent"
    ></div>

    <div
      class="fixed top-[60px] right-6 w-60 sm:w-64 bg-white rounded-lg shadow-2xl border border-gray-200 z-9999 overflow-hidden"
    >
      <div
        class="px-4 py-3 bg-gradient-to-r from-[#1AB394]/10 to-[#17a085]/10 border-b border-gray-200"
      >
        <div class="flex items-center gap-3">
          <img
            [src]="userInfo.avatar || 'assets/user.png'"
            class="w-12 h-12 rounded-full border-2 border-[#1AB394] shadow-sm object-cover"
            [alt]="userInfo.name"
          />
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-gray-900 truncate">
              {{ userInfo.name || 'Usuário' }}
            </p>
            <p class="text-xs text-gray-600 truncate">{{ userInfo.email }}</p>
            @if (userInfo.student_code) {
              <p class="text-xs text-gray-500 mt-0.5">RA: {{ userInfo.student_code }}</p>
            }
          </div>
        </div>

        <div class="mt-2">
          <span
            [class]="getRoleBadgeColor()"
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white"
          >
            {{ getRoleBadge() }}
          </span>
        </div>
      </div>

      <div class="py-1 max-h-[70vh] overflow-y-auto">
        @for (item of userMenuItems; track item.path) {
          <button
            (click)="navigateTo(item.path)"
            class="w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-[#1AB394]/8 active:bg-[#1AB394]/15 transition-colors"
          >
            {{ item.label }}
          </button>
          @if (item.divider) {
            <hr class="my-1 border-gray-200" />
          }
        }

        <hr class="my-1 border-gray-200" />
        <button
          (click)="logout()"
          class="w-full px-4 py-2.5 text-left text-sm text-red-600 hover:bg-red-50 active:bg-red-100 transition-colors font-medium"
        >
          Sair
        </button>
      </div>
    </div>
  }
</div>
